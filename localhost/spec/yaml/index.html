<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">


		<link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Mono" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="/highlight.css">
		<link rel="stylesheet" type="text/css" href="/reset.css">
		<link rel="stylesheet" type="text/css" href="/style.css">
		<link rel="stylesheet" type="text/css" href="/spec.css">

		<title>Pipeline Yaml Specification</title>
	</head>
	<body>
		<aside>
			<nav id="TableOfContents">
<ul>
<li><a href="#abstract">Abstract</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#conformance">Conformance</a></li>
<li><a href="#format">Format</a>
<ul>
<li><a href="#the-stage-interface">The <code>Stage</code> interface</a></li>
<li><a href="#the-step-interface">The <code>Step</code> interface</a>
<ul>
<li><a href="#the-name-attribute">The <code>name</code> attribute</a></li>
<li><a href="#the-alias-attribute">The <code>alias</code> attribute</a></li>
<li><a href="#the-image-attribute">The <code>image</code> attribute</a></li>
<li><a href="#the-pull-attribute">The <code>pull</code> attribute</a></li>
<li><a href="#the-detached-attribute">The <code>detached</code> attribute</a></li>
<li><a href="#the-privileged-attribute">The <code>privileged</code> attribute</a></li>
<li><a href="#the-working-dir-attribute">The <code>working_dir</code> attribute</a></li>
<li><a href="#the-environment-attribute">The <code>environment</code> attribute</a></li>
<li><a href="#the-entryptoint-attribute">The <code>entryptoint</code> attribute</a></li>
<li><a href="#the-command-attribute">The <code>command</code> attribute</a></li>
<li><a href="#the-devices-attribute">The <code>devices</code> attribute</a></li>
<li><a href="#the-dns-attribute">The <code>dns</code> attribute</a></li>
<li><a href="#the-dns-search-attribute">The <code>dns_search</code> attribute</a></li>
<li><a href="#the-extra-hosts-attribute">The <code>extra_hosts</code> attribute</a></li>
<li><a href="#the-shm-size-attribute">The <code>shm_size</code> attribute</a></li>
<li><a href="#the-tmpfs-attribute">The <code>tmpfs</code> attribute</a></li>
<li><a href="#the-volumes-attribute">The <code>volumes</code> attribute</a></li>
<li><a href="#the-networks-section">The <code>networks</code> section</a></li>
<li><a href="#the-resources-section">The <code>resources</code> section</a></li>
<li><a href="#the-auth-config-section">The <code>auth_config</code> section</a></li>
<li><a href="#the-on-success-attribute">The <code>on_success</code> attribute</a></li>
<li><a href="#the-on-failure-attribute">The <code>on_failure</code> attribute</a></li>
</ul></li>
<li><a href="#the-services-section">The <code>Services</code> section</a></li>
<li><a href="#the-workspace-interface">The <code>Workspace</code> interface</a></li>
<li><a href="#the-clone-interface">The <code>Clone</code> interface</a></li>
<li><a href="#the-branches-interface">The <code>Branches</code> interface</a></li>
</ul></li>
<li><a href="#security">Security</a></li>
<li><a href="#examples">Examples</a>
<ul>
<li><a href="#example-pipeline">Example Pipeline</a></li>
<li><a href="#example-pipeline-with-services">Example Pipeline with Services</a></li>
<li><a href="#example-pipeline-with-workspace">Example Pipeline with Workspace</a></li>
<li><a href="#example-pipeline-with-clone">Example Pipeline with Clone</a></li>
<li><a href="#example-pipeline-limits-branches">Example Pipeline limits Branches</a></li>
</ul></li>
<li><a href="#references">References</a>
<ul>
<li><a href="#normative-references">Normative References</a></li>
<li><a href="#informative-references">Informative References</a></li>
</ul></li>
</ul>
</nav>
		</aside>
		<main>
			<header>
				<h1>
					<span>Pipeline Yaml Specification</span>
					<small>Cloud Native Continuous Delivery (CNCD) Working Group</small>
				</h1>
			</header>

			<dl class="refs">
				<dt>This Version</dt>
				<dd>
					
					<a href="https://github.com/cncd/runtime-spec">https://github.com/cncd/runtime-spec</a>
					
				</dd>

				<dt>Previous Versions</dt>
				<dd>
					
					<a href="https://github.com/cncd/runtime-spec/tree/1.0.0">https://github.com/cncd/runtime-spec/tree/1.0.0</a>
					
				</dd>

				<dt>Editors</dt>
				<dd>
					
					<a href="https://github.com/bradrydzewski">bradrydzewski</a>
					
				</dd>

				<dt>Raise Issues</dt>
				<dd>
					
					<a href="https://github.com/cncd/runtime-spec/issues">https://github.com/cncd/runtime-spec/issues</a>
					
				</dd>
			</dl>

			<section class="spec">
			

<h1 id="abstract">Abstract</h1>

<p>This specification introduces a YAML format for defining continuous delivery pipelines and their container execution environments. A continuous delivery pipeline is an automated manifestation of your process for getting software from version control to release.</p>

<h1 id="introduction">Introduction</h1>

<p><em>This section is non-normative.</em></p>

<p>This specification introduces a YAML format for defining continuous delivery pipelines and their container execution environments. The YAML format described in this specification is a superset of the <a href="https://docs.docker.com/compose/compose-file/">docker-compose</a> yaml file. It is meant to be human readable and human writable, and should compile to the <a href="/spec/ir/">intermediate representation</a> per the specification.</p>

<p>This specification therefore targets both end-users writing pipeline configuration files, and compiler tools that convert the YAML representation to the intermediate representation.</p>

<h1 id="conformance">Conformance</h1>

<p>As well as sections marked as non-normative, all authoring guidelines, diagrams, examples, and notes in this specification are non-normative. Everything else in this specification is normative.</p>

<p>The key words &ldquo;MUST&rdquo;, &ldquo;MUST NOT&rdquo;, &ldquo;REQUIRED&rdquo;, &ldquo;SHALL&rdquo;, &ldquo;SHALL NOT&rdquo;, &ldquo;SHOULD&rdquo;, &ldquo;SHOULD NOT&rdquo;, &ldquo;RECOMMENDED&rdquo;, &ldquo;MAY&rdquo;, and &ldquo;OPTIONAL&rdquo; in this document are to be interpreted as described in <a href="https://tools.ietf.org/html/rfc2119">RFC2119</a>.</p>

<h1 id="format">Format</h1>

<p>The intermediate representation is a YAML document that defines the pipeline execution environment and execution steps. The intermediate representation consists of a top-level object that contains both required and optional members. Each of the members are defined below, as well as how their values are processed.</p>

<pre><code class="language-typescript">interface Manifest {
  pipeline: Stage[]
  networks: Network[]
  volumes: Volume[]
}
</code></pre>

<p>The <code>pipeline</code> attribute must contain a collection of one or more <code>stage</code> objects. The stages defined in the pipeline must be executed sequentially in the oder in which they are defined.</p>

<p>The <code>networks</code> attribute should contain a collection of one or more <code>network</code> objects. Networks may be referenced by individual steps and must be created prior to executing steps where a reference exists.</p>

<p>The <code>volumes</code> attribute should contain a collection of one or more <code>volume</code> objects. Volumes may be referenced by individual steps and must be created prior to executing steps where a reference exists.</p>

<h2 id="the-stage-interface">The <code>Stage</code> interface</h2>

<p>The <code>stage</code> object represents a set of processes that are grouped together and executed in parallel. The stage does not complete until all processes have exited.</p>

<pre><code class="language-typescript">interface Stage {
  name: string
  steps: Step[]
}
</code></pre>

<p>The <code>name</code> attribute is required and must match <code>[a-zA-Z0-9_-]</code></p>

<p>The <code>steps</code> attribute is required and must contain at least one <code>step</code>. If the stage contains multiple steps, each step is executed in parallel. The runtime agent should wait until all steps complete prior before it continues to the next stage in the pipeline.</p>

<h2 id="the-step-interface">The <code>Step</code> interface</h2>

<p>The <code>step</code> object defines a container process in the pipeline. The step attributes define how a container is created and started. Each of these attributes are defined below, as well as how their values are processed.</p>

<pre><code class="language-typescript">class Step {
  name: string
  alias: string
  image: string
  pull: boolean
  detached: boolean
  privileged: boolean
  working_dir: string
  environment: [string, string]
  entrypoint: string[]
  command: string[]
  devices: string[]
  extra_hosts: string[]
  dns: string[]
  dns_search: string[]
  shm_size: number
  tmpfs: string[]
  volumes: string[]
  networks: Network[]
  resources: Resources
  auth_config: AuthConfig
  on_failure: boolean
  on_success: boolean
}
</code></pre>

<h3 id="the-name-attribute">The <code>name</code> attribute</h3>

<p>The name of the container. This should be globally unique and must match <code>[a-zA-Z0-9_-]</code>.</p>

<h3 id="the-alias-attribute">The <code>alias</code> attribute</h3>

<p>The name of the container as defined by the user (i.e. user-friendly name). Containers in the pipeline will be able to access the container user the alias as the hostname. This value must be unique within the pipeline, and must match <code>[a-zA-Z0-9_-]</code>.</p>

<h3 id="the-image-attribute">The <code>image</code> attribute</h3>

<p>The fully qualified image to start the container from. When defining a docker image the full name, including the tag, must be provided.</p>

<pre><code>image: redis:latest
image: library/redis:latest
image: index.docker.io/library/redis:latest
</code></pre>

<h3 id="the-pull-attribute">The <code>pull</code> attribute</h3>

<p>Pull the latest version of the image from the remote image registry.</p>

<h3 id="the-detached-attribute">The <code>detached</code> attribute</h3>

<p>Start the container and run in the background. The parent stage must not wait for the container to complete execution. The container exit code must be ignored and must not cause the pipeline to exit on failure.</p>

<h3 id="the-privileged-attribute">The <code>privileged</code> attribute</h3>

<p>Start the container with extended privileges.</p>

<h3 id="the-working-dir-attribute">The <code>working_dir</code> attribute</h3>

<p>Start the container in the specified working directory. This must be the absolute path of the directory inside the container. The container engine (e.g. Docker) may create the working directory if it does not exist, however, this behavior may vary.</p>

<h3 id="the-environment-attribute">The <code>environment</code> attribute</h3>

<p>Set environment variables in the container.</p>

<pre><code class="language-json">{
  &quot;GOPATH&quot;: &quot;/go&quot;,
  &quot;DOCKER_HOST&quot;: &quot;unix:///var/run/docker.sock&quot;
}
</code></pre>

<h3 id="the-entryptoint-attribute">The <code>entryptoint</code> attribute</h3>

<p>todo</p>

<h3 id="the-command-attribute">The <code>command</code> attribute</h3>

<p>todo</p>

<h3 id="the-devices-attribute">The <code>devices</code> attribute</h3>

<p>Expose devices to a container. For example, a specific block storage device or loop device or audio device can be added to an otherwise unprivileged container.</p>

<pre><code class="language-json">[
  &quot;/dev/sdc:/dev/xvdc&quot;
]
</code></pre>

<h3 id="the-dns-attribute">The <code>dns</code> attribute</h3>

<p>Sets the IP addresses added as server lines to the container&rsquo;s <code>/etc/resolv.conf</code> file.</p>

<pre><code class="language-json">[
  &quot;8.8.8.8&quot;,
  &quot;9.9.9.9&quot;
]
</code></pre>

<h3 id="the-dns-search-attribute">The <code>dns_search</code> attribute</h3>

<p>Sets the domain names that are searched when a bare unqualified hostname is used inside of the container, by writing search lines into the container&rsquo;s <code>/etc/resolv.conf</code>.</p>

<pre><code class="language-json">[
  &quot;dc1.example.com&quot;,
  &quot;dc2.example.com&quot;
]
</code></pre>

<h3 id="the-extra-hosts-attribute">The <code>extra_hosts</code> attribute</h3>

<p>Add additional lines to the container&rsquo;s <code>/etc/hosts</code> file.</p>

<pre><code class="language-json">[
  &quot;somehost:162.242.195.82&quot;,
  &quot;otherhost:50.31.209.229&quot;
]
</code></pre>

<h3 id="the-shm-size-attribute">The <code>shm_size</code> attribute</h3>

<p>Sets the size of <code>/dev/shm</code> in bytes:</p>

<pre><code class="language-json">{
  &quot;shm_size&quot;: 64000000
}
</code></pre>

<h3 id="the-tmpfs-attribute">The <code>tmpfs</code> attribute</h3>

<p>Mount an empty temporary file system inside of the container.</p>

<pre><code class="language-json">[
  &quot;/run&quot;,
  &quot;/tmp&quot;
]
</code></pre>

<h3 id="the-volumes-attribute">The <code>volumes</code> attribute</h3>

<p>Mount paths or named volumes, optionally specifying a path on the host machine</p>

<h3 id="the-networks-section">The <code>networks</code> section</h3>

<pre><code class="language-typescript">interface Network {
  name: string
  aliases: string[]
}
</code></pre>

<h3 id="the-resources-section">The <code>resources</code> section</h3>

<pre><code class="language-typescript">interface Resources {
  limits: Limits
  reservations: Reservations
}

interface Limits {
  cpus: string
  memory: number
}

interface Reservations {
  cpus: string
  memory: number
}
</code></pre>

<h3 id="the-auth-config-section">The <code>auth_config</code> section</h3>

<pre><code class="language-typescript">interface AuthConfig {
  username: string
  password: string
  email: string
}
</code></pre>

<h3 id="the-on-success-attribute">The <code>on_success</code> attribute</h3>

<p>todo</p>

<h3 id="the-on-failure-attribute">The <code>on_failure</code> attribute</h3>

<p>todo</p>

<h2 id="the-services-section">The <code>Services</code> section</h2>

<p>todo</p>

<h2 id="the-workspace-interface">The <code>Workspace</code> interface</h2>

<p>todo</p>

<h2 id="the-clone-interface">The <code>Clone</code> interface</h2>

<p>todo</p>

<h2 id="the-branches-interface">The <code>Branches</code> interface</h2>

<p>todo</p>

<h1 id="security">Security</h1>

<p><em>This section is non-normative.</em></p>

<p>Compilers should audit the use of privileged features and capabilities because hostile authors could otherwise use these settings to compromise the host machine.</p>

<h1 id="examples">Examples</h1>

<p><em>This section is non-normative.</em></p>

<p>This section shows example features of this specification.</p>

<h2 id="example-pipeline">Example Pipeline</h2>

<p><em>This section is non-normative.</em></p>

<p>In the following example the pipeline is configured to execute two steps. The first step builds and tests the frontend code, and the second step builds and tests the backend code.</p>

<pre><code class="language-yaml">pipeline:
  frontend:
    image: node
    commands:
      - npm install
      - npm run tests

  backend:
    image: golang:1.7
    commands:
      - go get
      - go test
</code></pre>

<h2 id="example-pipeline-with-services">Example Pipeline with Services</h2>

<p><em>This section is non-normative.</em></p>

<p>In the following example the pipeline manifest defines a service container (redis) that is started prior to pipeline execution. Steps in the pipeline are able to access the service container using its alias hostname (redis).</p>

<pre><code class="language-yaml">pipeline:
  test:
    image: golang:1.7
    commands:
      - go get
      - go test

services:
  redis:
    image: redis:latest
</code></pre>

<h2 id="example-pipeline-with-workspace">Example Pipeline with Workspace</h2>

<p><em>This section is non-normative.</em></p>

<p>todo, add a description</p>

<pre><code class="language-yaml">workspace:
  base: /go
  path: src/github.com/foo/bar

pipeline:
  test:
    image: golang:1.7
    commands:
      - go get
      - go test
</code></pre>

<h2 id="example-pipeline-with-clone">Example Pipeline with Clone</h2>

<p><em>This section is non-normative.</em></p>

<p>todo, add a description</p>

<pre><code class="language-yaml">clone:
  git:
    image: plugins/git
    depth: 50

pipeline:
  test:
    image: golang:1.7
    commands:
      - go get
      - go test
</code></pre>

<h2 id="example-pipeline-limits-branches">Example Pipeline limits Branches</h2>

<p><em>This section is non-normative.</em></p>

<p>todo, add a description</p>

<pre><code class="language-yaml">pipeline:
  test:
    image: golang:1.7
    commands:
      - go get
      - go test

branches:
  include:
    - master
    - feature/*
  exclude:
    - feature/experiment/*
</code></pre>

<h1 id="references">References</h1>

<h2 id="normative-references">Normative References</h2>

<dl>
<dt>[YAML]</dt>
<dd>Oren Ben-Kiki, Clark Evans, Ingy döt Net. September 2009. <a href="http://yaml.org/spec">http://yaml.org/spec</a></dd>
</dl>

<h2 id="informative-references">Informative References</h2>

<dl>
<dt>[DOCKER]</dt>
<dd><a href="https://docs.docker.com/engine/reference/run/">Docker Run Reference</a>, Docker Inc.</dd>
<dt>[DOCKER COMPOSE]</dt>
<dd><a href="https://docs.docker.com/compose/compose-file/">Compose File Reference</a>, Docker Inc.</dd>
</dl>

			</section>
		</main>

		<script src="/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>
